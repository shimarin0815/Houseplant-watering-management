<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LeafLog â€“ è¦³è‘‰æ¤ç‰© æ°´ã‚„ã‚Šç®¡ç†</title>
  <meta name="description" content="è¦³è‘‰æ¤ç‰©ã®æ°´ã‚„ã‚Šã‚’è¨˜éŒ²ãƒ»é€šçŸ¥ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã ã‘ã§å‹•ãã‚·ãƒ³ã‚°ãƒ«ãƒšãƒ¼ã‚¸ã‚¢ãƒ—ãƒªã€‚" />
  <meta name="theme-color" content="#5ac49a" />
  <style>
    /* ====== Reset (å°ã•ã‚) ====== */
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;line-height:1.6;-webkit-font-smoothing:antialiased}
    img,svg{display:block;max-width:100%}
    button,input,select,textarea{font:inherit}

    /* ====== Theme ====== */
    :root{
      --bg: #0f1220;           /* æ·±ã‚ã®ç´º */
      --bg-soft: #121530;
      --panel: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.12);
      --text: #eef3f3;
      --muted:#a7b1b1;
      --brand: #59d1a9;
      --brand-2: #85f2cc;
      --accent: #6da6ff;
      --danger: #ff6b6b;
      --warn: #ffd166;
      --ok: #7ed957;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --radius-lg: 22px;
    }
    [data-theme="light"]{
      --bg:#f7faf9; --bg-soft:#f2f5f7; --panel:#ffffffcc; --border:#00000014; --text:#11181c; --muted:#4b5563;
      --shadow: 0 10px 30px rgba(8,16,24,.08);
    }
    @media (prefers-color-scheme: light){
      :root{ color-scheme:light; }
    }

    body{
      background: radial-gradient(1100px 700px at 10% -10%, #3a4564 0%, transparent 60%),
                  radial-gradient(1000px 600px at 120% 0%, #255f6d 0%, transparent 60%),
                  linear-gradient(180deg, var(--bg) 0%, var(--bg) 100%);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Sans", "Noto Sans JP", "Yu Gothic UI", "Meiryo", Arial, sans-serif;
      letter-spacing:.2px;
    }

    /* ====== Layout ====== */
    .container{max-width:1100px;margin-inline:auto;padding:28px}
    header{display:flex;align-items:center;gap:14px;justify-content:space-between;margin-bottom:24px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:38px;height:38px;border-radius:12px;background:
      conic-gradient(from 180deg at 50% 50%, var(--brand), var(--brand-2), var(--accent), var(--brand));
      box-shadow: 0 10px 24px rgba(90,196,154,.35), inset 0 0 28px rgba(255,255,255,.22);
    }
    .title{font-weight:800;font-size:1.25rem;letter-spacing:.3px}
    .subtitle{font-size:.9rem;color:var(--muted)}

    .toolbar{display:flex;gap:10px;align-items:center}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:var(--panel);
      color:var(--text);cursor:pointer;box-shadow:var(--shadow);backdrop-filter: blur(10px);
      transition: transform .06s ease, background .2s ease, border-color .2s ease, opacity .2s ease;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn:active{transform: translateY(0)}
    .btn-primary{background:linear-gradient(180deg, var(--brand-2), var(--brand)); color:#0d1b18;border-color:transparent;font-weight:700}
    .btn-danger{background:linear-gradient(180deg, #ffb4b4, var(--danger)); color:#2b0a0a;border-color:transparent;font-weight:700}
    .btn-ghost{background:transparent;border-color:var(--border)}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--panel);font-size:.85rem;color:var(--muted)}

    .filters{display:flex;gap:8px;flex-wrap:wrap}
    .filters .seg{padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:var(--panel);cursor:pointer}
    .filters .seg[aria-pressed="true"]{background:linear-gradient(180deg, #d4ffe5, #b8ffd7); color:#0b3d2e; border-color:transparent; font-weight:700}

    .grid{display:grid;grid-template-columns: repeat(auto-fill, minmax(260px,1fr)); gap:16px;margin-top:16px}

    .card{position:relative;border:1px solid var(--border);background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.04));
      padding:16px;border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter: blur(12px);}
    .card h3{margin:2px 0 6px;font-size:1.05rem}
    .meta{font-size:.9rem;color:var(--muted)}

    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-size:.8rem}
    .chip.over{background:#ffe9e9;color:#5b1212;border-color:#ffd0d0}
    .chip.soon{background:#fff7da;color:#684f00;border-color:#ffe9a5}
    .chip.ok{background:#e9ffe6;color:#0f3b08;border-color:#caffb8}

    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:10px}
    .row .left{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

    .actions{display:flex;gap:8px}
    .icon-btn{display:inline-grid;place-items:center;width:36px;height:36px;border-radius:10px;border:1px solid var(--border);
      background:var(--panel);cursor:pointer}
    .icon-btn:hover{transform:translateY(-1px)}

    .empty{border:1px dashed var(--border);padding:28px;border-radius:var(--radius-lg);text-align:center;color:var(--muted);margin-top:18px}

    /* ====== Modal (dialog) ====== */
    dialog{border:none;border-radius:20px;max-width:560px;width:92vw;padding:0;background:transparent}
    dialog::backdrop{background: rgba(0,0,0,.5)}
    .modal{border:1px solid var(--border);background:var(--panel);backdrop-filter: blur(12px); box-shadow:var(--shadow);
      padding:20px;border-radius:20px}
    .modal h2{margin:0 0 12px}
    .form{display:grid;gap:12px}
    label{font-size:.9rem;color:var(--muted)}
    input[type="text"], input[type="number"], input[type="date"], textarea{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.85);
      color:#0b1616;outline:none
    }
    textarea{min-height:72px;resize:vertical}

    /* ====== Footer info ====== */
    .footer{margin-top:28px;color:var(--muted);font-size:.85rem;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}

    /* ====== Utility ====== */
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <div class="container" id="app">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">LeafLog</div>
          <div class="subtitle">è¦³è‘‰æ¤ç‰©ã®ã€Œæ°´ã‚„ã‚Šã€ã‚’ã€æ°—æŒã¡ã‚ˆãã€‚</div>
        </div>
      </div>
      <div class="toolbar">
        <button class="btn pill" id="notifBtn" title="ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é€šçŸ¥"><span id="notifState">ğŸ”” é€šçŸ¥ã‚ªãƒ•</span></button>
        <button class="btn pill" id="backupBtn" title="ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—(JSON)ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
        <label class="btn pill" title="ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ">
          â¤´ï¸ å¾©å…ƒ
          <input id="restoreInput" type="file" accept="application/json" class="sr-only" />
        </label>
        <button class="btn" id="themeBtn" title="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">ğŸŒ— ãƒ†ãƒ¼ãƒ</button>
        <button class="btn btn-primary" id="addBtn">ï¼‹ æ¤ç‰©ã‚’è¿½åŠ </button>
      </div>
    </header>

    <section class="row" aria-label="ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼">
      <div class="left filters" id="filters">
        <button class="seg" data-filter="all" aria-pressed="true">ã™ã¹ã¦</button>
        <button class="seg" data-filter="due">æœŸé™åˆ°æ¥</button>
        <button class="seg" data-filter="soon">24æ™‚é–“ä»¥å†…</button>
        <button class="seg" data-filter="ok">ä½™è£•ã‚ã‚Š</button>
      </div>
      <div class="pill" id="summary">0é‰¢</div>
    </section>

    <section id="grid" class="grid" aria-live="polite" aria-busy="false"></section>
    <div id="empty" class="empty" hidden>
      ã¾ã æ¤ç‰©ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br />
      å³ä¸Šã®ã€Œæ¤ç‰©ã‚’è¿½åŠ ã€ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†ğŸŒ±
    </div>

    <div class="footer">
      <div>ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã§å‹•ä½œã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ä¸è¦ã€‚</div>
      <div id="clock">--:--</div>
    </div>
  </div>

  <!-- ====== Add/Edit Modal ====== -->
  <dialog id="plantDialog" aria-label="æ¤ç‰©ãƒ•ã‚©ãƒ¼ãƒ ">
    <form method="dialog" class="modal" id="plantForm">
      <h2 id="dialogTitle">æ¤ç‰©ã‚’è¿½åŠ </h2>
      <div class="form">
        <div>
          <label for="name">åå‰ï¼ˆä¾‹ï¼šãƒãƒˆã‚¹ï¼‰</label>
          <input id="name" name="name" type="text" required maxlength="30" placeholder="ãƒ¬ã‚ªãƒ³" />
        </div>
        <div>
          <label for="species">ç¨®é¡ï¼ˆä»»æ„ï¼‰</label>
          <input id="species" name="species" type="text" maxlength="40" placeholder="ãƒ•ã‚£ã‚«ã‚¹ãƒ»ã‚¦ãƒ³ãƒ™ãƒ©ãƒ¼ã‚¿" />
        </div>
        <div class="row">
          <div style="flex:1">
            <label for="freq">æ°´ã‚„ã‚Šé–“éš”ï¼ˆæ—¥ï¼‰</label>
            <input id="freq" name="freq" type="number" min="1" max="60" value="7" required />
          </div>
          <div style="flex:1">
            <label for="last">æœ€å¾Œã«æ°´ã‚„ã‚Šã—ãŸæ—¥</label>
            <input id="last" name="last" type="date" />
          </div>
        </div>
        <div>
          <label for="notes">ãƒ¡ãƒ¢ï¼ˆç½®ãå ´æ‰€ã‚„å…‰ãªã©ï¼‰</label>
          <textarea id="notes" name="notes" placeholder="åŒ—å´ã®çª“è¾ºã€‚ä¹¾ã„ãŸã‚‰ãŸã£ã·ã‚Šã€‚"></textarea>
        </div>
      </div>
      <div class="row" style="margin-top:14px">
        <div class="left">
          <button class="btn btn-danger" id="deleteBtn" type="button" hidden>ğŸ—‘ï¸ å‰Šé™¤</button>
        </div>
        <div class="actions">
          <button class="btn btn-ghost" value="cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="btn btn-primary" id="saveBtn" value="default">ä¿å­˜</button>
        </div>
      </div>
    </form>
  </dialog>

  <script>
    // ====== å°ã•ãªãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const pad = (n)=> String(n).padStart(2,'0');
    const todayDateStr = ()=>{ const d=new Date(); d.setHours(0,0,0,0); return d; };
    const toDateInput = (d)=> `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const parseDateInput = (s)=>{ const [y,m,dd]=s.split('-').map(Number); const d=new Date(y,m-1,dd); d.setHours(0,0,0,0); return d; };
    const addDays = (d, n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x };
    const fmt = (d)=> new Intl.DateTimeFormat('ja-JP',{ dateStyle:'medium'}).format(d);
    const nowISO = ()=> new Date().toISOString();

    function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,9); }

    // çŠ¶æ…‹ã®ç¨®é¡: over(æœŸé™åˆ°æ¥/è¶…é), soon(24hä»¥å†…), ok
    function statusOf(next){
      const now = new Date();
      if(next <= now) return 'over';
      const diff = next - now; // ms
      if(diff <= 24*60*60*1000) return 'soon';
      return 'ok';
    }

    // æ¬¡ã®æ°´ã‚„ã‚Šæ—¥ = æœ€å¾Œã®æ°´ã‚„ã‚Š + é–“éš”ï¼ˆæ—¥ï¼‰
    function calcNext(lastDate, freqDays){
      return addDays(lastDate, Number(freqDays));
    }

    // ====== ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å±¤ ======
    const LS_KEY = 'leaflog_plants_v1';
    function loadPlants(){
      try{ const raw = localStorage.getItem(LS_KEY); if(!raw) return []; const arr = JSON.parse(raw); return arr.map(p=>({...p, last:new Date(p.last), next:new Date(p.next)})); }
      catch(e){ console.error(e); return [] }
    }
    function savePlants(plants){
      localStorage.setItem(LS_KEY, JSON.stringify(plants.map(p=>({...p, last:p.last.toISOString(), next:p.next.toISOString()}))));
    }

    // ====== ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¹ãƒˆã‚¢ï¼ˆãƒªã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã£ã½ã„ï¼‰ ======
    const store = new Proxy({
      plants: loadPlants(),
      filter: 'all',
      theme: localStorage.getItem('leaflog_theme') || (matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark'),
      selectedId: null,
    },{
      set(obj, key, value){
        obj[key] = value;
        if(key==='plants') savePlants(obj.plants);
        render();
        return true;
      }
    });

    // åˆæœŸãƒ‡ãƒ¼ã‚¿ï¼ˆç©ºãªã‚‰ã‚µãƒ³ãƒ—ãƒ«ã‚’1ä»¶ï¼‰
    if(store.plants.length===0){
      const last = todayDateStr(); last.setDate(last.getDate()-2); // 2æ—¥å‰
      const next = calcNext(last, 7);
      store.plants = [{ id:uid(), name:'ãƒ¬ã‚ªãƒ³', species:'ãƒãƒˆã‚¹', freq:7, last, next, notes:'åŒ—å´ã®çª“è¾ºã€‚ä¹¾ã„ãŸã‚‰ãŸã£ã·ã‚Šã€‚', notifiedFor:null, createdAt: nowISO() }];
    }

    // ====== é€šçŸ¥ ======
    function updateNotifUI(){
      const el = $('#notifState');
      if(!('Notification' in window)) { el.textContent = 'ğŸ”• é€šçŸ¥éå¯¾å¿œ'; return }
      const p = Notification.permission;
      el.textContent = p==='granted' ? 'ğŸ”” é€šçŸ¥ã‚ªãƒ³' : (p==='denied' ? 'ğŸ”• é€šçŸ¥æ‹’å¦' : 'ğŸ”” è¨±å¯ã—ã¦ã­');
    }
    async function requestNotif(){
      if(!('Notification' in window)) return alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
      const res = await Notification.requestPermission();
      updateNotifUI();
      if(res==='granted'){
        new Notification('LeafLog é€šçŸ¥ã‚’ã‚ªãƒ³ã«ã—ã¾ã—ãŸ ğŸŒ¿',{ body:'æœŸé™ãŒæ¥ãŸã‚‰ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ï¼ˆã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹ã¨é€šçŸ¥ã¯æ­¢ã¾ã‚Šã¾ã™ï¼‰' });
      }
    }
    function maybeNotify(plant){
      if(!('Notification' in window) || Notification.permission!=='granted') return;
      const next = new Date(plant.next);
      const key = next.toISOString();
      if(plant.notifiedFor === key) return; // åŒã˜æœŸæ—¥ã§é‡è¤‡é€šçŸ¥ã—ãªã„
      const now = new Date();
      if(now >= next){
        const n = new Notification(`æ°´ã‚„ã‚Šã‚¿ã‚¤ãƒ ï¼š${plant.name}` ,{
          body:`${fmt(next)} ãŒç›®å®‰ã€‚è¨˜éŒ²ã—ãŸã‚‰ã€Œä»Šæ°´ã‚„ã‚Šã€ãƒœã‚¿ãƒ³ï¼`,
        });
        n.onclick = ()=> window.focus();
        // è¨˜éŒ²
        plant.notifiedFor = key;
        store.plants = [...store.plants]; // å¤‰æ›´ã‚’ä¿å­˜ï¼†å†æç”»
      }
    }

    function pollDue(){
      store.plants.forEach(p=> maybeNotify(p));
    }
    setInterval(pollDue, 60*1000); // 1åˆ†ãŠã
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) pollDue(); });

    // ====== ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ======
    function render(){
      document.documentElement.setAttribute('data-theme', store.theme);
      updateNotifUI();
      $('#summary').textContent = `${store.plants.length}é‰¢`;

      const grid = $('#grid');
      const empty = $('#empty');

      // ãƒ•ã‚£ãƒ«ã‚¿
      const now = new Date();
      const filtered = store.plants.filter(p=>{
        const status = statusOf(new Date(p.next));
        if(store.filter==='all') return true;
        if(store.filter==='due') return status==='over';
        if(store.filter==='soon') return status==='soon';
        if(store.filter==='ok') return status==='ok';
      });

      // ã‚½ãƒ¼ãƒˆ: over -> soon -> okã€ã•ã‚‰ã«æ¬¡å›æ—¥ä»˜ãŒæ—©ã„é †
      const order = {over:0, soon:1, ok:2};
      filtered.sort((a,b)=>{
        const sa = order[statusOf(new Date(a.next))];
        const sb = order[statusOf(new Date(b.next))];
        if(sa!==sb) return sa-sb;
        return new Date(a.next) - new Date(b.next);
      });

      grid.innerHTML = '';
      if(filtered.length===0){ empty.hidden=false; grid.setAttribute('aria-busy','false'); return }
      empty.hidden=true;

      for(const p of filtered){
        const next = new Date(p.next);
        const last = new Date(p.last);
        const s = statusOf(next);
        const leftDays = Math.ceil((next - now) / (24*60*60*1000));

        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          <h3>${escapeHtml(p.name)}</h3>
          <div class="meta">${escapeHtml(p.species||'ï¼ˆç¨®é¡ æœªè¨­å®šï¼‰')}</div>
          <div class="row" style="margin-top:8px">
            <div class="left">
              <span class="chip ${s}">
                ${s==='over' ? 'â° æœŸé™åˆ°æ¥' : s==='soon' ? 'ğŸŸ¡ ã‚‚ã†ã™ã' : 'ğŸŸ¢ ä½™è£•ã‚ã‚Š'}
              </span>
              <span class="pill">æ¬¡å›ï¼š${fmt(next)}</span>
              <span class="pill">å‰å›ï¼š${fmt(last)}</span>
              <span class="pill">é–“éš”ï¼š${p.freq}æ—¥</span>
            </div>
          </div>
          <p class="meta" style="margin-top:8px">${escapeHtml(p.notes||'')}</p>
          <div class="row" style="margin-top:12px">
            <div class="left"></div>
            <div class="actions">
              <button class="btn icon-btn" title="ä»Šæ°´ã‚„ã‚Š" data-act="water">ğŸ’§</button>
              <button class="btn icon-btn" title="ç·¨é›†" data-act="edit">âœï¸</button>
              <button class="btn icon-btn" title="å‰Šé™¤" data-act="delete">ğŸ—‘ï¸</button>
            </div>
          </div>
        `;

        card.querySelector('[data-act="water"]').onclick = ()=> waterNow(p.id);
        card.querySelector('[data-act="edit"]').onclick = ()=> openDialog('edit', p.id);
        card.querySelector('[data-act="delete"]').onclick = ()=> deletePlant(p.id);

        grid.appendChild(card);
      }
      grid.setAttribute('aria-busy','false');
    }

    function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]) ); }

    // ====== CRUD ======
    function waterNow(id){
      const idx = store.plants.findIndex(p=> p.id===id);
      if(idx<0) return;
      const last = new Date(); last.setHours(0,0,0,0); // æ—¥ä»˜å˜ä½
      const p = store.plants[idx];
      const next = calcNext(last, p.freq);
      const updated = {...p, last, next, notifiedFor:null};
      store.plants = Object.assign([...store.plants], {[idx]:updated});
    }

    function deletePlant(id){
      if(!confirm('ã“ã®æ¤ç‰©ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      store.plants = store.plants.filter(p=> p.id!==id);
    }

    // ====== ãƒ€ã‚¤ã‚¢ãƒ­ã‚° ======
    const dialog = $('#plantDialog');
    const form = $('#plantForm');
    const deleteBtn = $('#deleteBtn');

    function openDialog(mode, id){
      store.selectedId = id || null;
      $('#dialogTitle').textContent = mode==='edit' ? 'æ¤ç‰©ã‚’ç·¨é›†' : 'æ¤ç‰©ã‚’è¿½åŠ ';
      deleteBtn.hidden = mode!=='edit';

      const today = toDateInput(new Date());
      $('#last').value = today;
      $('#freq').value = 7;
      $('#name').value = '';
      $('#species').value = '';
      $('#notes').value = '';

      if(mode==='edit' && id){
        const p = store.plants.find(x=> x.id===id);
        if(p){
          $('#name').value = p.name;
          $('#species').value = p.species||'';
          $('#freq').value = p.freq;
          $('#last').value = toDateInput(new Date(p.last));
          $('#notes').value = p.notes||'';
        }
        deleteBtn.onclick = ()=>{ deletePlant(id); dialog.close(); };
      }

      dialog.showModal();
    }

    $('#addBtn').onclick = ()=> openDialog('add');

    form.addEventListener('close', ()=>{});
    form.addEventListener('submit', (e)=> e.preventDefault());

    $('#saveBtn').onclick = ()=>{
      const name = $('#name').value.trim(); if(!name) return alert('åå‰ã‚’å…¥ã‚Œã¦ã­');
      const species = $('#species').value.trim();
      const freq = Math.max(1, Math.min(60, Number($('#freq').value||7)));
      const last = parseDateInput($('#last').value || toDateInput(new Date()));
      const notes = $('#notes').value.trim();
      const next = calcNext(last, freq);

      if(store.selectedId){
        store.plants = store.plants.map(p=> p.id===store.selectedId ? {...p, name, species, freq, last, next, notes, notifiedFor:null} : p);
      }else{
        store.plants = [...store.plants, { id:uid(), name, species, freq, last, next, notes, notifiedFor:null, createdAt: nowISO() }];
      }
      dialog.close();
    };

    // ====== ãƒ•ã‚£ãƒ«ã‚¿ã¨ãƒ†ãƒ¼ãƒ ======
    $('#filters').addEventListener('click', (e)=>{
      const b = e.target.closest('[data-filter]'); if(!b) return;
      store.filter = b.dataset.filter;
      $$('#filters .seg').forEach(x=> x.setAttribute('aria-pressed', x===b ? 'true' : 'false'));
    });

    $('#themeBtn').onclick = ()=>{
      store.theme = store.theme==='light' ? 'dark' : 'light';
      localStorage.setItem('leaflog_theme', store.theme);
    };

    // ====== é€šçŸ¥ãƒœã‚¿ãƒ³ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒ ======
    $('#notifBtn').onclick = requestNotif;

    $('#backupBtn').onclick = ()=>{
      const data = JSON.stringify(store.plants.map(p=>({...p, last:p.last.toISOString(), next:p.next.toISOString()})), null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `leaflog-backup-${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      setTimeout(()=> URL.revokeObjectURL(url), 1000);
    };

    $('#restoreInput').addEventListener('change', async (e)=>{
      const file = e.target.files[0]; if(!file) return;
      try{
        const text = await file.text();
        const arr = JSON.parse(text);
        const restored = arr.map(p=> ({...p, last:new Date(p.last), next:new Date(p.next)}));
        store.plants = restored;
        alert('å¾©å…ƒã—ã¾ã—ãŸ');
      }catch(err){ alert('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
      e.target.value = '';
    });

    // ====== æ™‚è¨ˆï¼ˆãŠã¾ã‘ï¼‰ ======
    function tick(){
      const d=new Date(); $('#clock').textContent = `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    setInterval(tick, 1000); tick();

    // ====== åˆæœŸåŒ– ======
    (function init(){
      // ãƒ•ã‚£ãƒ«ã‚¿UIåˆæœŸåŒ–
      $$('#filters .seg').forEach(x=> x.setAttribute('aria-pressed', x.dataset.filter==='all' ? 'true' : 'false'));
      render();
      pollDue();
    })();
  </script>
</body>
</html>
